resources:
  pipelines:
    - pipeline: AzDoAgentDrainerBuild
      project: Pipelines
      source: UKHO.AzDoAgentDrainer
      trigger:
        branches:
          include:
            - master

trigger:
  branches:
    include:
      - master
  paths:
    include:
    - '*'
    exclude:
    - README.md

pr: none

variables:
- group: AzDO-variables

# pool: 'UKHO Ubuntu 1804'
pool:
  vmimage: 'ubuntu-latest'

container: ukhydrographicoffice/terraform-azure:latest

steps:
- script: |
    cd ubuntu-agent-vm
    sed -i -e "s/<subscriptionID>/$SUBSCRIPTIONID/g" ubuntu-agent-vm-aib.json
    sed -i -e "s/<rgName>/$IMAGERESOURCEGROUP/g" ubuntu-agent-vm-aib.json
    sed -i -e "s/<region>/$REGION/g" ubuntu-agent-vm-aib.json
    sed -i -e "s/<sharedImageGalleryName>/$SHAREDIMAGEGALLERYNAME/g" ubuntu-agent-vm-aib.json
    sed -i -e "s/<imageDefName>/$IMAGEDEFNAME/g" ubuntu-agent-vm-aib.json
    sed -i -e "s/<runOutputName>/$RUNOUTPUTNAME/g" ubuntu-agent-vm-aib.json
    sed -i -e "s/<replicationRegion>/$REPLICATIONREGION/g" ubuntu-agent-vm-aib.json    
    cat ubuntu-agent-vm-aib.json
  displayName: 'String replace variable names'

- bash: |
    az login --service-principal --username "$TERRAFORM-CLIENT-ID" --password "$TERRAFORM-CLIENT-SECRET" --tenant "$TERRAFORM-TENANT-ID"
    az account set --subscription $SUBSCRIPTIONID
    cd ubuntu-agent-vm
    az resource create \
      --resource-group $IMAGERESOURCEGROUP \
      --properties @ubuntu-agent-vm-aib.json \
      --is-full-object \
      --resource-type Microsoft.VirtualMachineImages/imageTemplates \
      -n ubuntu-agent-vm-aib
  displayName: 'Deploy AIB template'
  env:
    TERRAFORM-TENANT-ID: $(TERRAFORM-TENANT-ID)
    TERRAFORM-CLIENT-ID: $(TERRAFORM-CLIENT-ID)
    TERRAFORM-CLIENT-SECRET: $(TERRAFORM-CLIENT-SECRET)

- task: AzureCLI@2 
  inputs:
    azureSubscription: 'AzDo Live'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az resource invoke-action \
        --resource-group $IMAGERESOURCEGROUP \
        --resource-type  Microsoft.VirtualMachineImages/imageTemplates \
        -n ubuntu-agent-vm-aib \
        --action Run 
  displayName: 'Build the image'    

- task: AzureCLI@2 
  inputs:
    azureSubscription: 'AzDo Live'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az resource delete \
       --resource-group $IMAGERESOURCEGROUP \
       --resource-type Microsoft.VirtualMachineImages/imageTemplates \
       -n ubuntu-agent-vm-aib
  condition: always()
  displayName: 'Delete the AIB template'    
